'use strict';var _isEmpty2=require('lodash/isEmpty'),_isEmpty3=_interopRequireDefault(_isEmpty2),_omit2=require('lodash/omit'),_omit3=_interopRequireDefault(_omit2),_extends=Object.assign||function(a){for(var c,b=1;b<arguments.length;b++)for(var d in c=arguments[b],c)Object.prototype.hasOwnProperty.call(c,d)&&(a[d]=c[d]);return a};Object.defineProperty(exports,'__esModule',{value:!0});exports.default=createInstantSearchManager;var _algoliasearchHelper=require('algoliasearch-helper'),_algoliasearchHelper2=_interopRequireDefault(_algoliasearchHelper),_createWidgetsManager=require('./createWidgetsManager'),_createWidgetsManager2=_interopRequireDefault(_createWidgetsManager),_createStore=require('./createStore'),_createStore2=_interopRequireDefault(_createStore),_highlightTags=require('./highlightTags.js'),_highlightTags2=_interopRequireDefault(_highlightTags);function _interopRequireDefault(a){return a&&a.__esModule?a:{default:a}}function _defineProperty(a,b,c){return b in a?Object.defineProperty(a,b,{value:c,enumerable:!0,configurable:!0,writable:!0}):a[b]=c,a}function createInstantSearchManager(a){function d(D){return A.getWidgets().filter(function(E){return!!E.getMetadata}).map(function(E){return E.getMetadata(D)})}function e(){y={};var D=A.getWidgets().filter(function(G){return!!G.getSearchParameters}).filter(function(G){return!G.multiIndexContext}).reduce(function(G,H){return H.getSearchParameters(G)},z);y[D.index]=p;var E=A.getWidgets().filter(function(G){return!!G.getSearchParameters}).filter(function(G){return G.multiIndexContext&&G.multiIndexContext.targetedIndex!==p}).reduce(function(G,H){var I=H.multiIndexContext.targetedIndex,J=G.find(function(K){return K.targetedIndex===I});return J?J.widgets.push(H):G.push({targetedIndex:I,widgets:[H]}),G},[]),F=A.getWidgets().filter(function(G){return!!G.getSearchParameters}).filter(function(G){return G.multiIndexContext&&G.multiIndexContext.targetedIndex===p}).reduce(function(G,H){return H.getSearchParameters(G)},D);return{sharedParameters:D,mainIndexParameters:F,derivatedWidgets:E}}function f(){if(!C){var D=e(w.state),E=D.sharedParameters,F=D.mainIndexParameters,G=D.derivatedWidgets;Object.keys(x).forEach(function(H){return x[H].detach()}),x={},w.setState(E),G.forEach(function(H){var I=H.targetedIndex,J=w.derive(function(){var K=H.widgets.reduce(function(L,M){return M.getSearchParameters(L)},E);return y[K.index]=I,K});J.on('result',g),J.on('error',h),x[I]=J}),w.setState(F),w.search()}}function g(D){var E=B.getState(),F=E.results?E.results:{};F=!(0,_isEmpty3.default)(x)&&F.getFacetByName?{}:F,(0,_isEmpty3.default)(x)?F=D:F[y[D.index]]=D;var G=(0,_omit3.default)(_extends({},B.getState(),{results:F,searching:!1}),'resultsFacetValues');B.setState(G)}function h(D){var E=(0,_omit3.default)(_extends({},B.getState(),{error:D,searching:!1}),'resultsFacetValues');B.setState(E)}var p=a.indexName,q=a.initialState,r=q===void 0?{}:q,s=a.algoliaClient,t=a.searchParameters,u=t===void 0?{}:t,v=new _algoliasearchHelper.SearchParameters(_extends({},u,{index:p},_highlightTags2.default)),w=(0,_algoliasearchHelper2.default)(s,p,v);w.on('result',g),w.on('error',h);var x={},y={},z=w.state,A=(0,_createWidgetsManager2.default)(function(){var D=d(B.getState().widgets);B.setState(_extends({},B.getState(),{metadata:D,searching:!0,error:null})),f()}),B=(0,_createStore2.default)({widgets:r,metadata:[],results:null,error:null,searching:!1,searchingForFacetValues:!1}),C=!1;return{store:B,widgetsManager:A,getWidgetsIds:function(){return B.getState().metadata.reduce(function(D,E){return'undefined'==typeof E.id?D:D.concat(E.id)},[])},onExternalStateUpdate:function(D){var E=d(D);B.setState(_extends({},B.getState(),{widgets:D,metadata:E,searching:!0,error:null})),f()},transitionState:function(D){var E=B.getState().widgets;return A.getWidgets().filter(function(F){return!!F.transitionState}).reduce(function(F,G){return G.transitionState(E,F)},D)},onSearchForFacetValues:function(D){B.setState(_extends({},B.getState(),{searchingForFacetValues:!0})),w.searchForFacetValues(D.facetName,D.query).then(function(E){var F;B.setState(_extends({},B.getState(),{resultsFacetValues:_extends({},B.getState().resultsFacetValues,(F={},_defineProperty(F,D.facetName,E.facetHits),_defineProperty(F,'query',D.query),F)),searchingForFacetValues:!1}))},function(E){B.setState(_extends({},B.getState(),{error:E,searchingForFacetValues:!1}))}).catch(function(E){setTimeout(function(){throw E})})},updateClient:function(D){w.setClient(D),f()},updateIndex:function(D){z=z.setIndex(D),f()},skipSearch:function(){C=!0}}}